var map;S3.gis.ajax_loader=S3.Ap.concat("/static/img/ajax-loader.gif");S3.gis.marker_url=S3.Ap.concat("/static/img/markers/");OpenLayers.ImgPath=S3.Ap.concat("/static/img/gis/openlayers/");OpenLayers.IMAGE_RELOAD_ATTEMPTS=3;OpenLayers.Util.onImageLoadErrorColor="transparent";OpenLayers.ProxyHost=S3.Ap.concat("/gis/proxy?url=");S3.gis.proj4326=new OpenLayers.Projection("EPSG:4326");S3.gis.projection_current=new OpenLayers.Projection("EPSG:"+S3.gis.projection);
S3.gis.options={displayProjection:S3.gis.proj4326,projection:S3.gis.projection_current,theme:null,paddingForPopups:new OpenLayers.Bounds(50,10,200,300),units:S3.gis.units,maxResolution:S3.gis.maxResolution,maxExtent:S3.gis.maxExtent,numZoomLevels:S3.gis.numZoomLevels};S3.gis.cluster_distance=5;S3.gis.cluster_threshold=2;
function s3_gis_setCenter(a,b){a.transform(S3.gis.proj4326,S3.gis.projection_current);var c=a.lon,d=a.lat;b.transform(S3.gis.proj4326,S3.gis.projection_current);S3.gis.bounds=OpenLayers.Bounds.fromArray([c,d,b.lon,b.lat]);S3.gis.center=S3.gis.bounds.getCenterLonLat()}S3.gis.lat&&S3.gis.lon?(S3.gis.center=new OpenLayers.LonLat(S3.gis.lon,S3.gis.lat),S3.gis.center.transform(S3.gis.proj4326,S3.gis.projection_current)):S3.gis.bottom_left&&S3.gis.top_right&&s3_gis_setCenter(S3.gis.bottom_left,S3.gis.top_right);
S3.gis.plugins=[];function registerPlugin(a){S3.gis.plugins.push(a)}
Ext.onReady(function(){addMap();if(void 0==S3.gis.west_collapsed)S3.gis.west_collapsed=false;items=[S3.gis.layerTree];S3.gis.wmsBrowser&&items.push(S3.gis.wmsBrowser);S3.gis.searchCombo&&items.push(S3.gis.searchCombo);S3.gis.printFormPanel&&items.push(S3.gis.printFormPanel);S3.gis.legendPanel&&items.push(S3.gis.legendPanel);for(var a=0;a<S3.gis.plugins.length;++a)S3.gis.plugins[a].addToMapWindow(items);S3.gis.window?addMapWindow(items):addMapPanel(items);S3.gis.bounds&&map.zoomToExtent(S3.gis.bounds);
Ext.QuickTips.init()});
function addMap(){map=new OpenLayers.Map("center",S3.gis.options);addLayers();addControls();S3.gis.mapPanel=new GeoExt.MapPanel({region:"center",height:S3.gis.map_height,width:S3.gis.map_width,id:"mappanel",xtype:"gx_mappanel",map:map,center:S3.gis.center,zoom:S3.gis.zoom,plugins:[]});S3.gis.mapPanelContainer=new Ext.Panel({layout:"card",region:"center",id:"mappnlcntr",defaults:{border:false},items:[S3.gis.mapPanel],activeItem:0,tbar:new Ext.Toolbar,scope:this});if(S3.gis.Google&&S3.gis.Google.Earth){S3.gis.googleEarthPanel=
new gxp.GoogleEarthPanel({mapPanel:S3.gis.mapPanel});S3.gis.mapPanelContainer.items.items.push(S3.gis.googleEarthPanel)}addLayerTree();S3.gis.toolbar&&addToolbar();S3.gis.wms_browser_url&&addWMSBrowser();if(S3.i18n.gis_legend)S3.gis.legendPanel=new GeoExt.LegendPanel({id:"legendpanel",title:S3.i18n.gis_legend,defaults:{labelCls:"mylabel",style:"padding:5px"},bodyStyle:"padding:5px",autoScroll:true,collapsible:true,collapseMode:"mini",lines:false});if(S3.i18n.gis_search){var a=new GeoExt.ux.GeoNamesSearchCombo({map:map,
zoom:12});S3.gis.searchCombo=new Ext.Panel({id:"searchCombo",title:S3.i18n.gis_search,layout:"border",rootVisible:false,split:true,autoScroll:true,collapsible:true,collapseMode:"mini",lines:false,html:S3.i18n.gis_search_no_internet,items:[{region:"center",items:[a]}]})}for(a=0;a<S3.gis.plugins.length;++a)S3.gis.plugins[a].setup(map)}
function addMapPanel(a){S3.gis.mapWin=new Ext.Panel({id:"gis-map-panel",renderTo:"map_panel",autoScroll:true,maximizable:true,titleCollapse:true,height:S3.gis.map_height,width:S3.gis.map_width,layout:"border",items:[{region:"west",id:"tools",header:false,border:true,width:250,autoScroll:true,collapsible:true,collapseMode:"mini",collapsed:S3.gis.west_collapsed,split:true,items:a},S3.gis.mapPanelContainer]})}
function addMapWindow(a){S3.gis.mapWin=new Ext.Window({id:"gis-map-window",collapsible:true,constrain:true,closeAction:"hide",autoScroll:true,maximizable:true,titleCollapse:true,height:S3.gis.map_height,width:S3.gis.map_width,layout:"border",items:[{region:"west",id:"tools",header:false,border:true,width:250,autoScroll:true,collapsible:true,collapseMode:"mini",collapsed:S3.gis.west_collapsed,split:true,items:a},S3.gis.mapPanelContainer]});a=S3.gis.mapWin;if(!S3.gis.windowHide){if(S3.gis.windowNotClosable)a.closable=
false;a.show();a.maximize()}}
function addLayerTree(){var a=new Ext.tree.AsyncTreeNode({expanded:true,children:[{text:S3.i18n.gis_base_layers,nodeType:"gx_baselayercontainer",layerStore:S3.gis.mapPanel.layers,leaf:false,expanded:true},{text:S3.i18n.gis_overlays,nodeType:"gx_overlaylayercontainer",layerStore:S3.gis.mapPanel.layers,leaf:false,expanded:true}]});S3.gis.layerTree=new Ext.tree.TreePanel({id:"treepanel",title:S3.i18n.gis_layers,loader:new Ext.tree.TreeLoader({applyLoader:false}),root:a,rootVisible:false,split:true,autoScroll:true,
collapsible:true,collapseMode:"mini",lines:false,enableDD:true})}
function addWMSBrowser(){var a=new Ext.tree.AsyncTreeNode({expanded:true,loader:new GeoExt.tree.WMSCapabilitiesLoader({url:OpenLayers.ProxyHost+S3.gis.wms_browser_url,layerOptions:{buffer:1,singleTile:false,ratio:1,wrapDateLine:true},layerParams:{TRANSPARENT:"TRUE"},createNode:function(a){a.checked=a.leaf?false:void 0;return GeoExt.tree.WMSCapabilitiesLoader.prototype.createNode.apply(this,[a])}})});S3.gis.wmsBrowser=new Ext.tree.TreePanel({id:"wmsbrowser",title:S3.gis.wms_browser_name,root:a,rootVisible:false,
split:true,autoScroll:true,collapsible:true,collapseMode:"mini",lines:false,listeners:{checkchange:function(a,c){c===true?S3.gis.mapPanel.map.addLayer(a.attributes.layer):S3.gis.mapPanel.map.removeLayer(a.attributes.layer)}}})}
function addToolbar(){var a=S3.gis.mapPanelContainer.getTopToolbar(),b=new GeoExt.Action({control:new OpenLayers.Control.ZoomToMaxExtent,map:map,iconCls:"zoomfull",tooltip:S3.i18n.gis_zoomfull}),c=new GeoExt.Action({control:new OpenLayers.Control.ZoomBox({out:true}),map:map,iconCls:"zoomout",tooltip:S3.i18n.gis_zoomout,toggleGroup:"controls"}),d=new GeoExt.Action({control:new OpenLayers.Control.ZoomBox,map:map,iconCls:"zoomin",tooltip:S3.i18n.gis_zoomin,toggleGroup:"controls"});if(S3.gis.draw_feature==
"active")var e=false,f=true,g=false;else if(S3.gis.draw_polygon=="active"){f=e=false;g=true}else{e=true;g=f=false}S3.gis.panButton=new GeoExt.Action({control:new OpenLayers.Control.Navigation,map:map,iconCls:"pan-off",tooltip:S3.i18n.gis_pan,toggleGroup:"controls",allowDepress:true,pressed:e});a.add(b);navigator.geolocation&&addGeolocateControl(a);a.add(c);a.add(d);a.add(S3.gis.panButton);a.addSeparator();addNavigationControl(a);S3.gis.mapAdmin&&addSaveButton(a);a.addSeparator();addMeasureControls(a);
S3.gis.mgrs_url&&addPdfControl(a);if(S3.gis.draw_feature||S3.gis.draw_polygon){a.addSeparator();S3.gis.draw_feature&&addPointControl(a,f);S3.gis.draw_polygon&&addPolygonControl(a,g)}S3.gis.osm_oauth&&addPotlatchButton(a);S3.gis.Google&&S3.gis.Google.StreetviewButton&&addGoogleStreetviewControl(a);S3.gis.Google&&S3.gis.Google.Earth&&addGoogleEarthControl(a)}S3.gis.layers_all=[];S3.gis.format_geojson=new OpenLayers.Format.GeoJSON;
function addLayers(){if(S3.gis.layers_osm)for(i=0;i<S3.gis.layers_osm.length;i++)addOSMLayer(S3.gis.layers_osm[i]);try{addGoogleLayers()}catch(a){}S3.gis.Bing&&addBingLayers();if(S3.gis.layers_tms)for(i=0;i<S3.gis.layers_tms.length;i++)addTMSLayer(S3.gis.layers_tms[i]);if(S3.gis.layers_wms)for(i=0;i<S3.gis.layers_wms.length;i++)addWMSLayer(S3.gis.layers_wms[i]);try{addJSLayers()}catch(b){}if(S3.gis.layers_feature_queries)for(i=0;i<S3.gis.layers_feature_queries.length;i++)addGeoJSONLayer(S3.gis.layers_feature_queries[i]);
if(S3.gis.layers_features)for(i=0;i<S3.gis.layers_features.length;i++)addGeoJSONLayer(S3.gis.layers_features[i]);if(S3.gis.layers_geojson)for(i=0;i<S3.gis.layers_geojson.length;i++)addGeoJSONLayer(S3.gis.layers_geojson[i]);if(S3.gis.layers_georss)for(i=0;i<S3.gis.layers_georss.length;i++)addGeoJSONLayer(S3.gis.layers_georss[i]);if(S3.gis.layers_gpx)for(i=0;i<S3.gis.layers_gpx.length;i++)addGPXLayer(S3.gis.layers_gpx[i]);if(S3.gis.layers_kml){S3.gis.format_kml=new OpenLayers.Format.KML({extractStyles:true,
extractAttributes:true,maxDepth:2});for(i=0;i<S3.gis.layers_kml.length;i++)addKMLLayer(S3.gis.layers_kml[i])}if(S3.gis.layers_wfs)for(i=0;i<S3.gis.layers_wfs.length;i++)addWFSLayer(S3.gis.layers_wfs[i]);S3.gis.CoordinateGrid&&addCoordinateGrid();(S3.gis.features||S3.gis.draw_feature||S3.gis.draw_polygon||navigator.geolocation)&&addDraftLayer();if(S3.gis.features)for(i=0;i<S3.gis.features.length;i++){var c=new OpenLayers.Geometry.Point(S3.gis.features[i].lon,S3.gis.features[i].lat);c.transform(S3.gis.proj4326,
S3.gis.projection_current);S3.gis.draftLayer.addFeatures(new OpenLayers.Feature.Vector(c))}}function addBingLayers(){var a=S3.gis.Bing,b=a.ApiKey,c;if(a.Aerial){c=new OpenLayers.Layer.Bing({key:b,type:"Aerial",name:a.Aerial});map.addLayer(c)}if(a.Road){c=new OpenLayers.Layer.Bing({key:b,type:"Road",name:a.Road});map.addLayer(c)}if(a.Hybrid){c=new OpenLayers.Layer.Bing({key:b,type:"AerialWithLabels",name:a.Hybrid});map.addLayer(c)}}
function addCoordinateGrid(){map.addLayer(new OpenLayers.Layer.cdauth.CoordinateGrid(null,{name:S3.gis.CoordinateGrid.name,shortName:"grid",visibility:S3.gis.CoordinateGrid.visibility}))}
function addDraftLayer(){var a=S3.gis.marker_url+S3.gis.marker_default,b=S3.gis.marker_default_height,c=S3.gis.marker_default_width,d=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);d.graphicOpacity=1;d.graphicWidth=c;d.graphicHeight=b;d.graphicXOffset=-(c/2);d.graphicYOffset=-b;d.externalGraphic=a;S3.gis.draftLayer=new OpenLayers.Layer.Vector(S3.i18n.gis_draft_layer,{style:d,displayInLayerSwitcher:false});S3.gis.draftLayer.setVisibility(true);map.addLayer(S3.gis.draftLayer)}
function addGeoJSONLayer(a){var b=a.name,c=a.url;if(void 0!=a.marker_image)var d=S3.gis.marker_url+a.marker_image,e=a.marker_height,f=a.marker_width;else d="";var g=void 0!=a.refresh?a.refresh:900,j=void 0!=a.visibility?a.visibility:true,h=void 0!=a.opacity?a.opacity:1,k=void 0!=a.cluster_distance?a.cluster_distance:S3.gis.cluster_distance,l=void 0!=a.cluster_threshold?a.cluster_threshold:S3.gis.cluster_threshold,a=void 0!=a.projection?a.projection:4326,a=4326==a?S3.gis.proj4326:new OpenLayers.Projection("EPSG:"+
a),h=new OpenLayers.Style({label:"${label}",pointRadius:"${radius}",fillColor:"${fill}",fillOpacity:h,strokeColor:"${stroke}",strokeWidth:2,strokeOpacity:h,graphicWidth:"${graphicWidth}",graphicHeight:"${graphicHeight}",graphicXOffset:"${graphicXOffset}",graphicYOffset:"${graphicYOffset}",graphicOpacity:h,graphicName:"${graphicName}",externalGraphic:"${externalGraphic}"},{context:{graphicWidth:function(a){return a.cluster?"":a.attributes.marker_width?a.attributes.marker_width:f},graphicHeight:function(a){return a.cluster?
"":a.attributes.marker_height?a.attributes.marker_height:e},graphicXOffset:function(a){return a.cluster?"":a.attributes.marker_width?-(a.attributes.marker_width/2):-(f/2)},graphicYOffset:function(a){return a.cluster?"":a.attributes.marker_height?-a.attributes.marker_height:-e},graphicName:function(a){return a.cluster?"circle":a.attributes.shape?a.attributes.shape:"circle"},externalGraphic:function(a){return a.cluster?"":a.attributes.marker_url?a.attributes.marker_url:d},radius:function(a){return a.cluster?
Math.min(a.attributes.count/2,8)+12:a.attributes.size?a.attributes.size:12},fill:function(a){return a.cluster?"#8087ff":a.attributes.colour?a.attributes.colour:"#f5902e"},stroke:function(a){return a.cluster?"#2b2f76":a.attributes.colour?a.attributes.colour:"#f5902e"},label:function(a){var b="";if(a.cluster&&a.attributes.count>1)b=a.attributes.count;return b}}}),h=new OpenLayers.StyleMap({"default":h,select:{fillColor:"#ffdc33",strokeColor:"#ff9933"}}),b=new OpenLayers.Layer.Vector(b,{projection:a,
strategies:[new OpenLayers.Strategy.BBOX,new OpenLayers.Strategy.Refresh({force:true,interval:g*1E3}),new OpenLayers.Strategy.Cluster({distance:k,threshold:l})],styleMap:h,protocol:new OpenLayers.Protocol.HTTP({url:c,format:S3.gis.format_geojson})});b.setVisibility(j);b.events.on({featureselected:onGeojsonFeatureSelect,featureunselected:onFeatureUnselect});map.addLayer(b);S3.gis.layers_all.push(b)}
function addGoogleLayers(){var a=S3.gis.Google,b;if(a.MapMaker||a.MapMakerHybrid){if(a.Satellite){b=new OpenLayers.Layer.Google(a.Satellite,{type:G_SATELLITE_MAP,sphericalMercator:true});map.addLayer(b)}if(a.Maps){b=new OpenLayers.Layer.Google(a.Maps,{type:G_NORMAL_MAP,sphericalMercator:true});map.addLayer(b)}if(a.Hybrid){b=new OpenLayers.Layer.Google(a.Hybrid,{type:G_HYBRID_MAP,sphericalMercator:true});map.addLayer(b)}if(a.Terrain){b=new OpenLayers.Layer.Google(a.Terrain,{type:G_PHYSICAL_MAP,sphericalMercator:true});
map.addLayer(b)}if(a.MapMaker){b=new OpenLayers.Layer.Google(a.MapMaker,{type:G_MAPMAKER_NORMAL_MAP,sphericalMercator:true});map.addLayer(b)}if(a.MapMakerHybrid){b=new OpenLayers.Layer.Google(a.MapMakerHybrid,{type:G_MAPMAKER_HYBRID_MAP,sphericalMercator:true});map.addLayer(b)}}else{if(a.Satellite){b=new OpenLayers.Layer.Google(a.Satellite,{type:a.maps.MapTypeId.SATELLITE,numZoomLevels:22});map.addLayer(b)}if(a.Maps){b=new OpenLayers.Layer.Google(a.Maps,{numZoomLevels:20});map.addLayer(b)}if(a.Hybrid){b=
new OpenLayers.Layer.Google(a.Hybrid,{type:a.maps.MapTypeId.HYBRID,numZoomLevels:20});map.addLayer(b)}if(a.Terrain){b=new OpenLayers.Layer.Google(a.Terrain,{type:a.maps.MapTypeId.TERRAIN});map.addLayer(b)}}}
function addGPXLayer(a){var b=a.name,c=a.url,d=S3.gis.marker_url+a.marker_image,e=a.marker_height,f=a.marker_width,g=void 0!=a.waypoints?a.waypoints:true,j=void 0!=a.tracks?a.tracks:true,h=void 0!=a.routes?a.routes:true,k=void 0!=a.visibility?a.visibility:true,l=void 0!=a.opacity?a.opacity:1,n=void 0!=a.cluster_distance?a.cluster_distance:S3.gis.cluster_distance,a=void 0!=a.cluster_threshold?a.cluster_threshold:S3.gis.cluster_threshold,m=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);
if(g){m.graphicOpacity=l;m.graphicWidth=f;m.graphicHeight=e;m.graphicXOffset=-(f/2);m.graphicYOffset=-e;m.externalGraphic=d}else m.externalGraphic="";m.strokeColor="blue";m.strokeWidth=6;m.strokeOpacity=l;b=new OpenLayers.Layer.Vector(b,{projection:S3.gis.proj4326,strategies:[new OpenLayers.Strategy.Fixed,new OpenLayers.Strategy.Cluster({distance:n,threshold:a})],style:m,protocol:new OpenLayers.Protocol.HTTP({url:c,format:new OpenLayers.Format.GPX({extractAttributes:true,extractWaypoints:g,extractTracks:j,
extractRoutes:h})})});b.setVisibility(k);b.events.on({featureselected:onGpxFeatureSelect,featureunselected:onFeatureUnselect});map.addLayer(b);S3.gis.layers_all.push(b)}
function addKMLLayer(a){var b=a.name,c=a.url,d=S3.gis.marker_url+a.marker_image,e=void 0!=a.title?a.title:"name",f=void 0!=a.body?a.body:"description",g=void 0!=a.refresh?a.refresh:900,j=void 0!=a.visibility?a.visibility:true,h=void 0!=a.opacity?a.opacity:1,k=void 0!=a.cluster_distance?a.cluster_distance:S3.gis.cluster_distance,a=void 0!=a.cluster_threshold?a.cluster_threshold:S3.gis.cluster_threshold;S3.gis.image=new Image;S3.gis.image.onload=s3_gis_scaleImage;S3.gis.image.src=d;var l=OpenLayers.Util.extend({},
OpenLayers.Feature.Vector.style["default"]);l.graphicOpacity=h;l.graphicWidth=S3.gis.image.width;l.graphicHeight=S3.gis.image.height;l.graphicXOffset=-(S3.gis.image.width/2);l.graphicYOffset=-S3.gis.image.height;l.externalGraphic=d;b=new OpenLayers.Layer.Vector(b,{projection:S3.gis.proj4326,strategies:[new OpenLayers.Strategy.Fixed,new OpenLayers.Strategy.Cluster({distance:k,threshold:a}),new OpenLayers.Strategy.Refresh({force:true,interval:g*1E3})],style:l,protocol:new OpenLayers.Protocol.HTTP({url:c,
format:S3.gis.format_kml})});b.title=e;b.body=f;b.setVisibility(j);b.events.on({featureselected:onKmlFeatureSelect,featureunselected:onFeatureUnselect});map.addLayer(b);S3.gis.layers_all.push(b)}var s3_gis_scaleImage=function(){var a=S3.gis.image.height/S3.gis.image.width,b=Math.min(S3.gis.image.width,S3.gis.max_w),a=b*a;if(a>S3.gis.max_h){a=S3.gis.max_h;b=b*(b/a)}S3.gis.image.height=a;S3.gis.image.width=b};
function addOSMLayer(a){var b=a.name,c=[a.url1];void 0!=a.url2&&c.push(a.url2);void 0!=a.url3&&c.push(a.url3);var d=void 0!=a.visibility?a.visibility:true,b=new OpenLayers.Layer.TMS(b,c,{type:"png",getURL:osm_getTileURL,displayOutsideMaxExtent:true,numZoomLevels:void 0!=a.zoomLevels?a.zoomLevels:19,isBaseLayer:void 0!=a.base?a.base:true});if(void 0!=a.attribution)b.attribution=a.attribution;b.setVisibility(d);map.addLayer(b)}
function osm_getTileURL(a){var b=this.map.getResolution(),c=Math.round((a.left-this.maxExtent.left)/(b*this.tileSize.w)),a=Math.round((this.maxExtent.top-a.top)/(b*this.tileSize.h)),b=this.map.getZoom(),d=Math.pow(2,b);if(a<0||a>=d)return OpenLayers.Util.getImagesLocation()+"404.png";c=b+"/"+(c%d+d)%d+"/"+a+"."+this.type;a=this.url;a instanceof Array&&(a=this.selectUrl(c,a));return a+c}
function addTMSLayer(a){var b=a.name,c=[a.url];void 0!=a.url2&&c.push(a.url2);void 0!=a.url3&&c.push(a.url3);b=new OpenLayers.Layer.TMS(b,c,{layername:a.layername,type:void 0!=a.format?a.format:"png",numZoomLevels:void 0!=a.zoomLevels?a.zoomLevels:9});if(void 0!=a.attribution)b.attribution=a.attribution;map.addLayer(b)}
function addWFSLayer(a){var b=a.name,c=a.title,d=void 0!=a.styleField?a.styleField:"",e=void 0!=a.styleValues?a.styleValues:{},f=void 0!=a.visibility?a.visibility:true,g=void 0!=a.opacity?a.opacity:1,j=void 0!=a.cluster_distance?a.cluster_distance:S3.gis.cluster_distance,h=void 0!=a.cluster_threshold?a.cluster_threshold:S3.gis.cluster_threshold,a=new OpenLayers.Protocol.WFS({version:void 0!=a.version?a.version:"1.1.0",srsName:void 0!=a.projection?"EPSG:"+a.projection:"EPSG:4326",url:a.url,featureType:a.featureType,
featureNS:a.featureNS,geometryName:void 0!=a.geometryName?a.geometryName:"the_geom",schema:a.schema}),k={context:{radius:function(a){var b=12;a.cluster&&(b=Math.min(a.attributes.count/2,8)+12);return b},fill:function(a){var b="#f5902e";a.cluster&&(b="#8087ff");return b},stroke:function(a){var b="#f5902e";a.cluster&&(b="#2b2f76");return b},label:function(a){var b="";if(a.cluster&&a.attributes.count>1)b=a.attributes.count;return b}}};if(d&&e){k.context.fill=function(a){var b;$.each(e,function(c,e){c==
a.attributes[d]&&(b=e)});b||(b="#f5902e");a.cluster&&(b="#8087ff");return b};k.context.stroke=function(a){var b;$.each(e,function(c,e){c==a.attributes[d]&&(b=e)});b||(b="#f5902e");a.cluster&&(b="#2b2f76");return b}}g=new OpenLayers.Style({label:"${label}",pointRadius:"${radius}",fillColor:"${fill}",fillOpacity:g/2,strokeColor:"${stroke}",strokeWidth:2,strokeOpacity:g},k);g=new OpenLayers.StyleMap({"default":g,select:{fillColor:"#ffdc33",strokeColor:"#ff9933"}});projection=!projection||"4326"==projection?
S3.gis.proj4326:new OpenLayers.Projection("EPSG:"+projection);b=new OpenLayers.Layer.Vector(b,{maxFeatures:1E3,strategies:[new OpenLayers.Strategy.BBOX({ratio:1,resFactor:1}),new OpenLayers.Strategy.Cluster({distance:j,threshold:h})],projection:projection,protocol:a,styleMap:g});b.title=c;b.setVisibility(f);b.events.on({featureselected:onWfsFeatureSelect,featureunselected:onFeatureUnselect});map.addLayer(b);S3.gis.layers_all.push(b)}
function addWMSLayer(a){var b=void 0!=a.base?a.base:false,c=void 0!=a.transparent?a.transparent:true,d=void 0!=a.format?a.format:"image/png",e=void 0!=a.version?a.version:"1.1.1",f=void 0!=a.map?a.map:"",g=void 0!=a.style?a.style:"",j=void 0!=a.bgcolor?"0x"+a.bgcolor:"",h=void 0!=a.buffer?a.buffer:0,k=void 0!=a.tiled?a.tiled:false,l=void 0!=a.opacity?a.opacity:1,a=new OpenLayers.Layer.WMS(a.name,a.url,{layers:a.layers},{wrapDateLine:true,isBaseLayer:b,visibility:void 0!=a.visibility?a.visibility:
true});if(f)a.params.MAP=f;if(d)a.params.FORMAT=d;if(c)a.params.TRANSPARENT=true;if(e)a.params.VERSION=e;if(g)a.params.STYLES=g;if(j)a.params.BGCOLOR=j;if(k){a.params.TILED=true;a.params.TILESORIGIN=[map.maxExtent.left,map.maxExtent.bottom]}if(!b){a.opacity=l;a.buffer=h?h:0}map.addLayer(a)}
function s3_gis_loadDetails(a,b,c){$.ajax({url:a,success:function(a){$("#"+b).html(a);c.updateSize()},error:function(a,e,f){msg=f=="UNAUTHORIZED"?S3.i18n.gis_requires_login:a.responseText;$("#"+b+"_contentDiv").html(msg);c.updateSize()},dataType:"html"})}
function onGeojsonFeatureSelect(a){s3_gis_tooltipUnselect(a);var a=a.feature,b=S3.uid(),c=a.geometry.getBounds().getCenterLonLat(),d=false;if(a.cluster){for(var e,f,g=S3.i18n.gis_cluster_multiple+":<ul>",j=Math.min(a.cluster.length,9),h=0;h<j;h++){e=void 0!=a.cluster[h].attributes.popup?a.cluster[h].attributes.popup.split("<br />",1)[0]:a.cluster[h].attributes.name;if(void 0!=a.cluster[h].attributes.url){f=a.cluster[h].attributes.url;g=g+("<li><a href='javascript:s3_gis_loadClusterPopup(\""+f+'", "'+
b+"\")'>"+e+"</a></li>")}else g=g+("<li>"+e+"</li>")}g=g+"</ul>"+("<div align='center'><a href='javascript:s3_gis_zoomToSelectedFeature("+c.lon+","+c.lat+", 3)'>Zoom in</a></div>")}else if(void 0!=a.attributes.url)g=S3.i18n.gis_loading+"...<img src='"+S3.gis.ajax_loader+"' border=0 />";else{e=void 0==a.attributes.name?"":"<h3>"+a.attributes.name+"</h3>";f=void 0==a.attributes.description?"":"<p>"+a.attributes.description+"</p>";g=void 0==a.attributes.link?"":'<a href="'+a.attributes.link+'" target="_blank">'+
a.attributes.link+"</a>";if(void 0==a.attributes.data)j="";else if(a.attributes.data.indexOf("http://")===0)var d=true,k=S3.uid(),j='<div id="'+k+'">'+S3.i18n.gis_loading+"...<img src='"+S3.gis.ajax_loader+"' border=0 /></div>";else j="<p>"+a.attributes.data+"</p>";h=void 0==a.attributes.image?"":a.attributes.image.indexOf("http://")===0?'<img src="'+a.attributes.image+'" height=300 width=300>':"";g=e+f+g+j+h}c=new OpenLayers.Popup.FramedCloud(b,c,new OpenLayers.Size(200,200),g,null,true,onPopupClose);
void 0!=a.attributes.url?s3_gis_loadDetails(a.attributes.url,b+"_contentDiv",c):d&&s3_gis_loadDetails(a.attributes.data,k,c);a.popup=c;map.addPopup(c)}function onGpxFeatureSelect(a){s3_gis_tooltipUnselect(a)}
function onKmlFeatureSelect(a){s3_gis_tooltipUnselect(a);for(var a=a.feature,b=S3.uid(),c=a.geometry.getBounds().getCenterLonLat(),d=a.layer.title,e=a.attributes,f=typeof e[d],d="object"==f?e[d].value:e[d],g=a.layer.body.split(" "),j="",h=0;h<g.length;h++){f=typeof e[g[h]];if("object"==f){f=e[g[h]].displayName;f==""&&(f=g[h]);f="<b>"+f+"</b>: "+e[g[h]].value+"<br />"}else f=e[g[h]]+"<br />";j=j+f}j.search("<script")!=-1&&(j="Content contained Javascript! Escaped content below.<br />"+j.replace(/</g,
"<"));b=new OpenLayers.Popup.FramedCloud(b,c,new OpenLayers.Size(200,200),"<h3>"+d+"</h3>"+j,null,true,onPopupClose);a.popup=b;map.addPopup(b)}
function onWfsFeatureSelect(a){s3_gis_tooltipUnselect(a);var a=a.feature,b=S3.uid(),c=a.geometry.getBounds().getCenterLonLat(),d=a.layer.title;if(a.cluster){for(var e,f=S3.i18n.gis_cluster_multiple+":<ul>",g=Math.min(a.cluster.length,9),j=0;j<g;j++){e=a.cluster[j].attributes[d];f=f+("<li>"+e+"</li>")}f=f+"</ul>"+("<div align='center'><a href='javascript:s3_gis_zoomToSelectedFeature("+c.lon+","+c.lat+", 3)'>Zoom in</a></div>")}else{e=a.attributes;var d=e[d],h="";$.each(e,function(a,b){h=h+("<b>"+a+
":</b> "+b+"<br />")});f="<h3>"+d+"</h3>"+h}b=new OpenLayers.Popup.FramedCloud(b,c,new OpenLayers.Size(200,200),f,null,true,onPopupClose);a.popup=b;map.addPopup(b)}
function addControls(){map.addControl(new OpenLayers.Control.ScaleLine);S3.gis.mouse_position=="mgrs"?map.addControl(new OpenLayers.Control.MGRSMousePosition):S3.gis.mouse_position&&map.addControl(new OpenLayers.Control.MousePosition);map.addControl(new OpenLayers.Control.Permalink);map.addControl(new OpenLayers.Control.OverviewMap({mapOptions:S3.gis.options}));addPopupControls()}
function addPopupControls(){S3.gis.popupControl=new OpenLayers.Control.SelectFeature(S3.gis.layers_all,{toggle:true,clickout:true,multiple:true});S3.gis.highlightControl=new OpenLayers.Control.SelectFeature(S3.gis.layers_all,{hover:true,highlightOnly:true,eventListeners:{featurehighlighted:s3_gis_tooltipSelect,featureunhighlighted:s3_gis_tooltipUnselect}});map.addControl(S3.gis.highlightControl);map.addControl(S3.gis.popupControl);S3.gis.highlightControl.activate();S3.gis.popupControl.activate()}
function onFeatureUnselect(a){a=a.feature;if(a.popup){map.removePopup(a.popup);a.popup.destroy();delete a.popup}}function onPopupClose(){for(;map.popups.length;)map.removePopup(map.popups[0])}
function s3_gis_tooltipSelect(a){a=a.feature;if(!a.cluster&&a.popup==null){if(S3.gis.tooltipPopup!=null){map.removePopup(S3.gis.tooltipPopup);S3.gis.tooltipPopup.destroy();S3.gis.lastFeature!=null&&delete S3.gis.lastFeature.popup;S3.gis.tooltipPopup=null}S3.gis.lastFeature=a;var b=a.geometry.getBounds().getCenterLonLat(),c=a.attributes,d;if(void 0!=c.popup)d=c.popup;else if(void 0!=c.name)d=c.name;else{var e=a.layer.title;void 0!=e&&(d="object"==typeof c[e]?c[e].value:c[e])}if(d)S3.gis.tooltipPopup=
new OpenLayers.Popup("activetooltip",b,new OpenLayers.Size(80,12),d,false);if(S3.gis.tooltipPopup!=null){S3.gis.tooltipPopup.contentDiv.style.backgroundColor="ffffcb";S3.gis.tooltipPopup.contentDiv.style.overflow="hidden";S3.gis.tooltipPopup.contentDiv.style.padding="3px";S3.gis.tooltipPopup.contentDiv.style.margin="10px";S3.gis.tooltipPopup.closeOnMove=true;S3.gis.tooltipPopup.autoSize=true;S3.gis.tooltipPopup.opacity=0.7;a.popup=S3.gis.tooltipPopup;map.addPopup(S3.gis.tooltipPopup)}}}
function s3_gis_tooltipUnselect(a){a=a.feature;if(a!=null&&a.popup!=null){map.removePopup(a.popup);a.popup.destroy();delete a.popup;S3.gis.tooltipPopup=null;S3.gis.lastFeature=null}}function s3_gis_loadClusterPopup(a,b){var c=S3.i18n.gis_loading+"...<img src='"+S3.gis.ajax_loader+"' border=0 />";$("#"+b+"_contentDiv").html(c);$.get(a,function(a){$("#"+b+"_contentDiv").html(a);map.popups[0].updateSize()},"html")}
function s3_gis_zoomToSelectedFeature(a,b,c){a=new OpenLayers.LonLat(a,b);c=map.getZoom()+c;map.setCenter(a,c);for(c=0;c<map.popups.length;c++)map.removePopup(map.popups[c])}
function addGeolocateControl(a){var b=S3.gis.draftLayer,c={fillColor:"#000",fillOpacity:0.1,strokeWidth:0},d=new OpenLayers.Control.Geolocate({geolocationOptions:{enableHighAccuracy:false,maximumAge:0,timeout:7E3}});map.addControl(d);d.events.register("locationupdated",this,function(a){b.removeAllFeatures();var d=new OpenLayers.Feature.Vector(OpenLayers.Geometry.Polygon.createRegularPolygon(new OpenLayers.Geometry.Point(a.point.x,a.point.y),a.position.coords.accuracy/2,40,0),{},c);b.addFeatures([new OpenLayers.Feature.Vector(a.point,
{},{graphicName:"cross",strokeColor:"#f00",strokeWidth:2,fillOpacity:0,pointRadius:10}),d]);map.zoomToExtent(b.getDataExtent());s3_gis_pulsate(d)});d.events.register("locationfailed",this,function(){OpenLayers.Console.log("Location detection failed")});S3.gis.geolocateControl=d;d=new Ext.Toolbar.Button({iconCls:"geolocation",tooltip:S3.i18n.gis_geoLocate,handler:function(){S3.gis.draftLayer.removeAllFeatures();S3.gis.geolocateControl.activate()}});a.addButton(d)}
var s3_gis_pulsate=function(a){var b=a.geometry.getCentroid(),c=a.geometry.getBounds(),d=Math.abs((c.right-c.left)/2),e=0,f="up";window.resizeInterval=window.setInterval(function(){e>16&&clearInterval(window.resizeInterval);var c=d*0.03/d;switch(e){case 4:case 12:f="down";break;case 8:f="up"}f!=="up"&&(c=-Math.abs(c));a.geometry.resize(1+c,b);S3.gis.draftLayer.drawFeature(a);e++},50,b,d)};
function addGoogleEarthControl(a){var b=new Ext.Toolbar.Button({iconCls:"googleearth",tooltip:S3.gis.Google.Earth,enableToggle:true,toggleHandler:function(a,b){if(b===true){S3.gis.mapPanelContainer.getLayout().setActiveItem(1);S3.gis.mapWin.items.items[0].collapse();S3.gis.googleEarthPanel.on("earthready",function(){addGoogleEarthKmlLayers()})}else{S3.gis.mapPanelContainer.getLayout().setActiveItem(0);S3.gis.mapWin.items.items[0].expand()}}});a.addSeparator();a.addButton(b)}
function addGoogleEarthKmlLayers(){if(S3.gis.layers_features)for(i=0;i<S3.gis.layers_features.length;i++){var a=S3.gis.layers_features[i];if(void 0!=a.visibility?a.visibility:1){a=S3.public_url+a.url.replace("geojson","kml");google.earth.fetchKml(S3.gis.googleEarthPanel.earth,a,googleEarthKmlLoaded)}}}function googleEarthKmlLoaded(a){a&&S3.gis.googleEarthPanel.earth.getFeatures().appendChild(a)}
function addGoogleStreetviewControl(a){var b=OpenLayers.Class(OpenLayers.Control,{defaults:{pixelTolerance:1,stopSingle:true},initialize:function(a){this.handlerOptions=OpenLayers.Util.extend({},this.defaults);OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},trigger:function(a){openStreetviewPopup(map.getLonLatFromViewPortPx(a.xy))}});S3.gis.StreetviewClicker=new b({autoactivate:false});map.addControl(S3.gis.StreetviewClicker);
b=new Ext.Toolbar.Button({iconCls:"streetview",tooltip:S3.gis.Google.StreetviewButton,toggleGroup:"controls",allowDepress:true,enableToggle:true,toggleHandler:function(a,b){b===true?S3.gis.StreetviewClicker.activate():S3.gis.StreetviewClicker.deactivate()}});a.addSeparator();a.addButton(b)}
function openStreetviewPopup(a){a||(a=map.getCenter());S3.gis.sv_popup&&S3.gis.sv_popup.anc&&S3.gis.sv_popup.close();S3.gis.sv_popup=new GeoExt.Popup({title:S3.gis.Google.StreetviewTitle,location:a,width:300,height:300,collapsible:true,map:S3.gis.mapPanel,items:[new gxp.GoogleStreetViewPanel]});S3.gis.sv_popup.show()}
function addMeasureControls(a){var b=new OpenLayers.Style;b.addRules([new OpenLayers.Rule({symbolizer:{Point:{pointRadius:5,graphicName:"circle",fillColor:"white",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#f5902e"},Line:{strokeWidth:3,strokeOpacity:1,strokeColor:"#f5902e",strokeDashstyle:"dash"},Polygon:{strokeWidth:2,strokeOpacity:1,strokeColor:"#f5902e",fillColor:"white",fillOpacity:0.5}}})]);var c=new OpenLayers.StyleMap({"default":b}),b=new OpenLayers.Control.Measure(OpenLayers.Handler.Path,
{geodesic:true,persist:true,handlerOptions:{layerOptions:{styleMap:c}}});b.events.on({measure:function(a){alert(S3.i18n.gis_length_message+" "+a.measure.toFixed(2)+" "+a.units)}});c=new OpenLayers.Control.Measure(OpenLayers.Handler.Polygon,{geodesic:true,persist:true,handlerOptions:{layerOptions:{styleMap:c}}});c.events.on({measure:function(a){alert(S3.i18n.gis_area_message+" "+a.measure.toFixed(2)+" "+a.units+"2")}});b=new GeoExt.Action({control:b,map:map,iconCls:"measure-off",tooltip:S3.i18n.gis_length_tooltip,
toggleGroup:"controls",allowDepress:true,enableToggle:true});c=new GeoExt.Action({control:c,map:map,iconCls:"measure-area",tooltip:S3.i18n.gis_area_tooltip,toggleGroup:"controls",allowDepress:true,enableToggle:true});a.add(b);a.add(c)}
function addNavigationControl(a){var b=new OpenLayers.Control.NavigationHistory;map.addControl(b);b.activate();var c=new Ext.Toolbar.Button({iconCls:"back",tooltip:S3.i18n.gis_navPrevious,handler:b.previous.trigger}),b=new Ext.Toolbar.Button({iconCls:"next",tooltip:S3.i18n.gis_navNext,handler:b.next.trigger});a.addButton(c);a.addButton(b)}
function addPointControl(a,b){OpenLayers.Handler.PointS3=OpenLayers.Class(OpenLayers.Handler.Point,{dblclick:function(){return true},CLASS_NAME:"OpenLayers.Handler.PointS3"});S3.gis.pointButton=new GeoExt.Action({control:new OpenLayers.Control.DrawFeature(S3.gis.draftLayer,OpenLayers.Handler.PointS3,{featureAdded:function(a){S3.gis.lastDraftFeature?S3.gis.lastDraftFeature.destroy():S3.gis.draftLayer.features.length>1&&S3.gis.draftLayer.features[0].destroy();var b=a.geometry.getBounds().getCenterLonLat();
b.transform(S3.gis.projection_current,S3.gis.proj4326);$("#gis_location_lon").val(b.lon);$("#gis_location_lat").val(b.lat);S3.gis.lastDraftFeature=a}}),handler:function(){S3.gis.pointButton.items[0].pressed?$(".olMapViewport").addClass("crosshair"):$(".olMapViewport").removeClass("crosshair")},map:map,iconCls:"drawpoint-off",tooltip:S3.i18n.gis_draw_feature,toggleGroup:"controls",allowDepress:true,enableToggle:true,pressed:b});a.add(S3.gis.pointButton)}
function addPolygonControl(a,b){S3.gis.polygonButton=new GeoExt.Action({control:new OpenLayers.Control.DrawFeature(S3.gis.draftLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:4,snapAngle:90},featureAdded:function(a){S3.gis.lastDraftFeature&&S3.gis.lastDraftFeature.destroy();var b=a.geometry.transform(S3.gis.projection_current,S3.gis.proj4326).toString();$("#gis_search_polygon_input").val(b);S3.gis.lastDraftFeature=a}}),handler:function(){S3.gis.polygonButton.items[0].pressed?$(".olMapViewport").addClass("crosshair"):
$(".olMapViewport").removeClass("crosshair")},map:map,iconCls:"drawpolygon-off",tooltip:S3.i18n.gis_draw_polygon,toggleGroup:"controls",allowDepress:true,pressed:b,enableToggle:true,activateOnEnable:true,deactivateOnDisable:true});a.add(S3.gis.polygonButton)}
function addPotlatchButton(a){var b=new Ext.Toolbar.Button({iconCls:"potlatch",tooltip:S3.i18n.gis_potlatch,handler:function(){var a=map.getCenter(),b=map.getZoom();b<14&&(b=14);a.transform(map.getProjectionObject(),S3.gis.proj4326);a=S3.Ap.concat("/gis/potlatch2/potlatch2.html")+"?lat="+a.lat+"&lon="+a.lon+"&zoom="+b;window.open(a)}});a.addSeparator();a.addButton(b)}
function addSaveButton(a){if(!S3.gis.region)S3.gis.region=1;var b=new Ext.Toolbar.Button({iconCls:"save",tooltip:S3.i18n.gis_save,handler:function(){var a=map.getCenter(),b=map.getZoom();a.transform(map.getProjectionObject(),S3.gis.proj4326);var e=S3.Ap.concat("/gis/config/"+S3.gis.region+".url/update");Ext.Ajax.request({url:e,method:"GET",params:{lat:a.lat,lon:a.lon,zoom:b}})}});a.addSeparator();a.addButton(b)}
function addPdfControl(a){selectPdfControl=new OpenLayers.Control;OpenLayers.Util.extend(selectPdfControl,{draw:function(){this.box=new OpenLayers.Handler.Box(this,{done:this.getPdf});this.box.activate()},response:function(a){this.w.destroy();var a=(new OpenLayers.Format.GML).read(a.responseText),b=a.length+" pdfs. <br /><ul>";if(a.length)for(var e=0;e<a.length;e++)var f=a[e],b=b+("<li><a href='"+a[e].attributes.url+"'>"+(f.attributes.utm_zone+f.attributes.grid_zone+f.attributes.grid_square+f.attributes.easting+
f.attributes.northing)+"</a></li>");this.w=new Ext.Window({html:b+"</ul>",width:300,title:"Results",height:200});this.w.show()},getPdf:function(a){var b=map.getLonLatFromPixel(new OpenLayers.Pixel(a.left,a.bottom)).transform(S3.gis.projection_current,S3.gis.proj4326),a=map.getLonLatFromPixel(new OpenLayers.Pixel(a.right,a.top)).transform(S3.gis.projection_current,S3.gis.proj4326);bbox=(new OpenLayers.Bounds(b.lon,b.lat,a.lon,a.lat)).toBBOX();OpenLayers.Request.GET({url:S3.gis.mgrs_url+"&bbox="+bbox,
callback:OpenLayers.Function.bind(this.response,this)});this.w=new Ext.Window({html:"Searching "+S3.gis.mgrs_name+", please wait.",width:200,title:"Please Wait."});this.w.show()}});var b="Select "+S3.gis.mgrs_name,b=new GeoExt.Action({text:b,control:selectPdfControl,map:map,toggleGroup:"controls",allowDepress:false,tooltip:b});a.addSeparator();a.add(b)};
